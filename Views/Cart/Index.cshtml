@model List<StyleSphere.Models.CartViewModel>

@{
    ViewData["Title"] = "Cart";
    Layout = "_Layout";
}

<div class="small-container" id="cart-page">
    <table>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Subtotal</th>
        </tr>

        @if (Model != null && Model.Count > 0)
        {
            decimal total = 0;

            foreach (var item in Model)
            {

                var subtotal = item.price * item.quantity;
                total += subtotal;
                <tr>
                    <td>
                        <div class="cart-info">
                            <img src="@item.buyimage" />
                            <div>
                                <p>@item.name</p>
                                <small>Price: ₹@item.price.00</small><br />
                                <a asp-controller="Cart" asp-action="RemoveFromCart" asp-route-id="@item.id">Remove</a>
                            </div>
                        </div>
                    </td>
                    <td>
                        <form asp-action="UpdateQuantity" asp-controller="Cart" method="post" style="display:inline;">
                            <input type="hidden" name="id" value="@item.id" />
                            <input type="number" name="quantity" value="@item.quantity" min="1" style="width: 60px;" />
                            <button type="submit" class="btn btn-sm">Update</button>
                        </form>
                    </td>
                    <td>₹@subtotal.00</td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td style="justify-content:cetner;">Your cart is empty.</td>
            </tr>
        }
    </table>

    @if (Model != null && Model.Count > 0)
    {
        decimal total = Model.Sum(i => i.price * i.quantity);
        decimal tax = total * 0.2M;
        decimal grandTotal = total + tax;

        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td>₹@total.00</td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td>₹@tax.00</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td>₹@grandTotal.00</td>
                </tr>
            </table>
        </div>
    }
</div>


@* <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> *@
@* <script src="~/js/site.js"></script> *@

@* <script>

    $(document).ready( function() {
        let cartItems = JSON.parse(sessionStorage.getItem("cartItems")) || [];

        $.getJSON("/Products/GetProducts" , function() {
            let cartHtml = "";
            let total = 0;

            cartItems.forEach( item => {
                let product = cartItems.find(p => p.id === item.id);
                if ( product ) {
                    console.log(product);
                    let subtotal = item.quantity * product.price;
                    total += subtotal;
                    cartHtml += `
                        <tr>
                            <td>
                                <div class="cart-info">
                                    <img src="/${product.image}"/>
                                    <div>
                                        <p>${product.name}</p>
                                        <small>Price: ${product.price}</small><br />
                                        <a href="#" class="remove-item" data-id="${item.id}">Remove</a>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="update-quantity" data-id="${item.id}" value="${item.quantity}" /></td>
                            <td>₹${subtotal}</td>
                        </tr>
                    `;
                }

            });

            //Updating the cart table dynamically
            $("#cart-page table").html(`
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                </tr>
                ${cartHtml}
            `);

            //Updating the price dynamically
            $(".total-price table").html(`
                <tr><td>SubTotal</td> <td>${total}</td></tr>
                <tr><td>Tax</td> <td>${total * 0.2}</td></tr>
                <tr><td>Total</td> <td>${total * 1.2}</td></tr>
            `);
        });

        //Removing item from cart
        $(document).on("click" , ".remove-item" , function () {
            let itemId = $(this).data("id");
            cartItems = cartItems.filter(item => item.id !== itemId);
            sessionStorage.setItem("cartItems" , JSON.stringify(cartItems));
            location.reload();
        });

        //Update Quantity in cart
        $(document).on("change" , ".update-quantity" , function () {
            let itemId = $(this).data("id");
            let newQuantity = $(this).val();
            cartItems = cartItems.map(item => item.id === itemId ? { ...item , quantity: parseInt(newQuantity)} : item);
            sessionStorage.setItem("cartItems" , JSON.stringify(cartItems));
            location.reload();
        });
    });

</script> *@
