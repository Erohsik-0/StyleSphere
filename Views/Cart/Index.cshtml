@{
    ViewData["Title"] = "Cart";
    Layout = "_Layout"; 

}


@* Cart Items Details *@
<div class="small-container" id="cart-page">

    <table>
        
        @*
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Subtotal</th>
        </tr> *@
        @* <tr>
            <td>
                <div class="cart-info">
                    <img src="~/images/buy-1.jpg"/>
                    <div>
                        <p>Red Printed T-Shirt</p>
                        <small>Price: ₹500.00</small>
                        <br />
                        <a href="">Remove</a>
                    </div>
                </div>
            </td>
            <td><input type="number" value="1"/></td>
            <td>₹500.00</td>
        </tr>
        <tr>
            <td>
                <div class="cart-info">
                    <img src="~/images/buy-2.jpg"/>
                    <div>
                        <p>Black Sports Shoe</p>
                        <small>Price: ₹500.00</small>
                        <br />
                        <a href="">Remove</a>
                    </div>
                </div>
            </td>
            <td><input type="number" value="1"/></td>
            <td>₹500.00</td>
        </tr>
        <tr>
            <td>
                <div class="cart-info">
                    <img src="~/images/buy-3.jpg"/>
                    <div>
                        <p>Grey Track Pant</p>
                        <small>Price: ₹500.00</small>
                        <br />
                        <a href="">Remove</a>
                    </div>
                </div>
            </td>
            <td><input type="number" value="1"/></td>
            <td>₹500.00</td>
        </tr> *@
    </table>

    <div class="total-price">

        <table>
            @* <tr>
                <td>Subtotal</td>
                <td>₹1500.00</td>
            </tr>
            <tr>
                <td>Tax</td>
                <td>₹300.00</td>
            </tr>
            <tr>
                <td>Total</td>
                <td>₹1800.00</td>
            </tr> *@
        </table>
    </div>

</div>




<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="~/js/site.js"></script>

<script>

    $(document).ready( function() {
        let cartItems = JSON.parse(sessionStorage.getItem("cartItems")) || [];

        $.getJSON("/Products/GetProducts" , function() {
            let cartHtml = "";
            let total = 0;

            cartItems.forEach( item => {
                let product = cartItems.find(p => p.id === item.id);
                if ( product ) {
                    console.log(product);
                    let subtotal = item.quantity * product.price;
                    total += subtotal;
                    cartHtml += `
                        <tr>
                            <td>
                                <div class="cart-info">
                                    <img src="/${product.image}"/>
                                    <div>
                                        <p>${product.name}</p>
                                        <small>Price: ${product.price}</small><br />
                                        <a href="#" class="remove-item" data-id="${item.id}">Remove</a>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" class="update-quantity" data-id="${item.id}" value="${item.quantity}" /></td>
                            <td>₹${subtotal}</td>
                        </tr>
                    `;
                }

            });

            //Updating the cart table dynamically
            $("#cart-page table").html(`
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Subtotal</th>
                </tr>
                ${cartHtml}
            `);

            //Updating the price dynamically
            $(".total-price table").html(`
                <tr><td>SubTotal</td> <td>${total}</td></tr>
                <tr><td>Tax</td> <td>${total * 0.2}</td></tr>
                <tr><td>Total</td> <td>${total * 1.2}</td></tr>
            `);
        });

        //Removing item from cart
        $(document).on("click" , ".remove-item" , function () {
            let itemId = $(this).data("id");
            cartItems = cartItems.filter(item => item.id !== itemId);
            sessionStorage.setItem("cartItems" , JSON.stringify(cartItems));
            location.reload();
        });

        //Update Quantity in cart
        $(document).on("change" , ".update-quantity" , function () {
            let itemId = $(this).data("id");
            let newQuantity = $(this).val();
            cartItems = cartItems.map(item => item.id === itemId ? { ...item , quantity: parseInt(newQuantity)} : item);
            sessionStorage.setItem("cartItems" , JSON.stringify(cartItems));
            location.reload();
        });
    });

</script>
